<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Fleet Hub</title>
  <style>
    :root{ color-scheme:light dark; --bg:#0b1220; --card:#0f172a; --muted:#94a3b8; --accent:#38bdf8; --border:#334155; }
    body{ margin:0; font:14px/1.5 "Segoe UI",system-ui,-apple-system,sans-serif; background:radial-gradient(circle at 20% 20%, #0f172a 0, #020617 38%, #000 80%); color:#e2e8f0; }
    header{ padding:14px 16px; display:flex; gap:12px; flex-wrap:wrap; align-items:center; border-bottom:1px solid #1e293b; background:#0b1220dd; backdrop-filter:blur(6px); position:sticky; top:0; z-index:1; }
    label{ display:flex; flex-direction:column; font-size:12px; color:var(--muted); gap:4px; }
    input{ padding:8px 10px; border-radius:10px; border:1px solid var(--border); background:rgba(255,255,255,0.04); color:inherit; min-width:240px; }
    button{ border:none; border-radius:999px; padding:9px 14px; font-weight:600; cursor:pointer; background:var(--accent); color:#0b1220; }
    button.secondary{ background:#1e293b; color:#e2e8f0; border:1px solid var(--border); }
    main{ padding:16px; display:grid; gap:16px; max-width:1200px; margin:0 auto; }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:14px; padding:14px; box-shadow:0 20px 60px #0008; }
    .card h3{ margin:0 0 8px; }
    .muted{ color:var(--muted); font-size:12px; }
    .row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    table{ width:100%; border-collapse:collapse; font-size:13px; }
    th,td{ border-bottom:1px solid #1f2937; padding:8px 6px; text-align:left; }
    th{ color:var(--muted); font-weight:600; position:sticky; top:0; background:var(--card); }
    .status{ display:inline-flex; gap:6px; align-items:center; }
    .dot{ width:10px; height:10px; border-radius:999px; background:#475569; }
    .dot.ok{ background:#22c55e; }
    .dot.offline{ background:#ef4444; }
    .pill{ border:1px solid var(--border); border-radius:999px; padding:2px 8px; font-size:12px; }
    textarea{ width:100%; min-height:80px; border-radius:12px; border:1px solid var(--border); background:#0f172a; color:inherit; padding:10px; resize:vertical; }
    .flex{ display:flex; gap:8px; flex-wrap:wrap; }
    .grow{ flex:1 1 0; }
    .mono{ font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; font-size:12px; }
    pre.mono{ margin:8px 0 0; background:#0b1220; border:1px solid #1f2937; padding:10px; border-radius:10px; overflow:auto; max-height:200px; }
    .clickable tr{ cursor:pointer; }
    .clip{ max-width:240px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  </style>
</head>
<body>
  <header>
    <label>Base URL
      <input id="base" placeholder="https://script.google.com/macros/s/.../exec"/>
    </label>
    <label>Token
      <input id="token" placeholder="api token"/>
    </label>
    <button id="btnSave">Save</button>
    <button id="btnRefresh" class="secondary">Refresh</button>
    <span id="msg" class="muted"></span>
    <span id="build" class="muted"></span>
  </header>
  <main>
    <section class="card">
      <div class="row" style="justify-content:space-between;">
        <div>
          <h3>Сводка</h3>
          <div class="muted" id="summary">—</div>
        </div>
        <div class="row">
          <label class="row" style="align-items:center; gap:6px; color:var(--muted);">
            <input type="checkbox" id="autoRefresh" style="width:auto; min-width:0;"/>
            auto 5s
          </label>
        </div>
      </div>
    </section>

    <section class="card">
      <h3>Команда устройствам</h3>
      <div class="flex">
        <label class="grow">Target ID (или all)
          <input id="cmdTarget" placeholder="all"/>
        </label>
        <label class="grow">Command
          <input id="cmdName" placeholder="reboot / snapshot / ..." />
        </label>
      </div>
      <label class="muted" style="margin-top:8px;">Payload (JSON, опционально)</label>
      <textarea id="cmdPayload" placeholder='{"foo":"bar"}'></textarea>
      <div class="row" style="justify-content:flex-end; margin-top:8px;">
        <button id="btnSend">Send</button>
      </div>
      <div id="cmdMsg" class="muted"></div>
    </section>

    <section class="card">
      <h3>Контроллеры</h3>
      <div class="muted" style="margin-bottom:6px;">Регистрации и последние heartbeats</div>
      <div style="overflow:auto; max-height:420px;">
        <table class="clickable">
          <thead>
            <tr>
              <th>ID</th><th>Name</th><th>Status</th><th>Last seen</th><th>FW</th><th>IP</th><th>Tags</th><th>Cfg</th><th>Info</th><th>Pending cmd</th>
            </tr>
          </thead>
          <tbody id="rows">
          </tbody>
        </table>
      </div>
    </section>

    <section class="card">
      <h3>Конфиг контроллера</h3>
      <div class="flex">
        <label class="grow">Target ID
          <input id="cfgTarget" placeholder="device id"/>
        </label>
        <div class="row" style="align-items:flex-end;">
          <button id="btnCfgLoad" class="secondary">Load</button>
          <button id="btnCfgSave">Save</button>
        </div>
      </div>
      <div class="row" style="margin-top:8px;">
        <button id="btnOpenFm" class="secondary" disabled>Open File Manager</button>
        <span id="netCheck" class="muted">Network: —</span>
      </div>
      <label class="muted" style="margin-top:8px;">Config (JSON)</label>
      <textarea id="cfgJson" class="mono" placeholder='{"sample_rate":5}'></textarea>
      <div id="cfgMsg" class="muted"></div>
      <label class="muted" style="margin-top:8px;">Selected device</label>
      <pre id="cfgInfo" class="mono">—</pre>
    </section>
  </main>

  <script>
    const els = {
      base:document.getElementById('base'),
      token:document.getElementById('token'),
      msg:document.getElementById('msg'),
      build:document.getElementById('build'),
      summary:document.getElementById('summary'),
      rows:document.getElementById('rows'),
      auto:document.getElementById('autoRefresh'),
      btnRefresh:document.getElementById('btnRefresh'),
      btnSave:document.getElementById('btnSave'),
      cmdTarget:document.getElementById('cmdTarget'),
      cmdName:document.getElementById('cmdName'),
      cmdPayload:document.getElementById('cmdPayload'),
      btnSend:document.getElementById('btnSend'),
      cmdMsg:document.getElementById('cmdMsg'),
      cfgTarget:document.getElementById('cfgTarget'),
      btnCfgLoad:document.getElementById('btnCfgLoad'),
      btnCfgSave:document.getElementById('btnCfgSave'),
      cfgJson:document.getElementById('cfgJson'),
      cfgMsg:document.getElementById('cfgMsg'),
      cfgInfo:document.getElementById('cfgInfo'),
      btnOpenFm:document.getElementById('btnOpenFm'),
      netCheck:document.getElementById('netCheck'),
    };

    const ls = {
      get(k, d){ try{ const v = localStorage.getItem(k); return v!==null ? v : d; }catch(_){ return d; } },
      set(k, v){ try{ localStorage.setItem(k, v); }catch(_){ } }
    };

    const state = { devices: [] };
    const BUILD_INFO = '2026-01-13 15:37 UTC';

    function init(){
      if (els.build) els.build.textContent = 'build ' + BUILD_INFO;
      els.base.value = ls.get('fleet.base','');
      els.token.value = ls.get('fleet.token','');
      els.auto.checked = ls.get('fleet.auto','1') === '1';
      els.cfgTarget.value = ls.get('fleet.cfgTarget','');
      els.btnSave.addEventListener('click', saveConfig);
      els.btnRefresh.addEventListener('click', refreshAll);
      els.btnSend.addEventListener('click', sendCommand);
      els.btnCfgLoad.addEventListener('click', loadConfig);
      els.btnCfgSave.addEventListener('click', saveConfigForDevice);
      els.rows.addEventListener('click', onRowClick);
      els.auto.addEventListener('change', () => {
        ls.set('fleet.auto', els.auto.checked ? '1':'0');
        schedule();
      });
      refreshAll();
      schedule();
    }

    function saveConfig(){
      ls.set('fleet.base', els.base.value.trim());
      ls.set('fleet.token', els.token.value.trim());
      flash('Saved');
      refreshAll();
    }

    let autoTimer = null;
    function schedule(){
      if (autoTimer) clearInterval(autoTimer);
      if (els.auto.checked){
        autoTimer = setInterval(refreshAll, 5000);
      }
    }

    async function refreshAll(){
      const base = els.base.value.trim();
      const token = els.token.value.trim();
      if (!base){ flash('Укажи base URL'); return; }
      try{
        const [summary, list] = await Promise.all([
          api(base, token, {mode:'status'}),
          api(base, token, {mode:'list'}),
        ]);
        renderSummary(summary);
        renderTable(list.devices || []);
        flash('OK');
      }catch(err){
        flash(formatErr(err));
      }
    }

    async function sendCommand(){
      const base = els.base.value.trim();
      const token = els.token.value.trim();
      const id = (els.cmdTarget.value.trim() || 'all');
      const cmd = els.cmdName.value.trim();
      let payload = null;
      if (!cmd){ els.cmdMsg.textContent = 'Команда не заполнена'; return; }
      if (els.cmdPayload.value.trim()){
        try{ payload = JSON.parse(els.cmdPayload.value); }
        catch(e){ els.cmdMsg.textContent = 'Payload: не JSON'; return; }
      }
      try{
        const resp = await api(base, token, {mode:'setCommand', id, command:cmd, payload});
        els.cmdMsg.textContent = resp.ok ? 'Отправлено' : (resp.error || 'error');
        refreshAll();
      }catch(err){
        els.cmdMsg.textContent = formatErr(err);
      }
    }

    async function loadConfig(){
      const base = els.base.value.trim();
      const token = els.token.value.trim();
      const id = els.cfgTarget.value.trim();
      if (!id){ els.cfgMsg.textContent = 'ID не задан'; return; }
      try{
        const resp = await api(base, token, {mode:'getConfig', id});
        els.cfgJson.value = resp.config ? JSON.stringify(resp.config, null, 2) : '';
        els.cfgMsg.textContent = resp.config ? `Загружено (rev ${resp.config_rev||0})` : 'Конфиг пуст';
      }catch(err){
        els.cfgMsg.textContent = formatErr(err);
      }
    }

    async function saveConfigForDevice(){
      const base = els.base.value.trim();
      const token = els.token.value.trim();
      const id = els.cfgTarget.value.trim();
      if (!id){ els.cfgMsg.textContent = 'ID не задан'; return; }
      let config = null;
      if (els.cfgJson.value.trim()){
        try{ config = JSON.parse(els.cfgJson.value); }
        catch(e){ els.cfgMsg.textContent = 'Config: не JSON'; return; }
      }
      try{
        const resp = await api(base, token, {mode:'setConfig', id, config});
        els.cfgMsg.textContent = resp.ok ? 'Сохранено' : (resp.error || 'error');
        refreshAll();
      }catch(err){
        els.cfgMsg.textContent = formatErr(err);
      }
    }

    function shouldUseJsonp(base){
      try{
        const u = new URL(base, location.href);
        if (u.origin === location.origin) return false;
        return u.hostname.includes('script.google.com');
      }catch(_){
        return false;
      }
    }

    function jsonpRequest(base, params){
      return new Promise((resolve, reject) => {
        const cbName = 'fleetHubCb_' + Date.now() + '_' + Math.random().toString(36).slice(2);
        const u = new URL(base, location.href);
        Object.entries(params || {}).forEach(([k,v]) => {
          if (v === undefined) return;
          u.searchParams.set(k, typeof v === 'object' ? JSON.stringify(v) : String(v));
        });
        u.searchParams.set('callback', cbName);

        const script = document.createElement('script');
        const timer = setTimeout(() => {
          cleanup();
          reject(new Error('jsonp_timeout'));
        }, 8000);

        function cleanup(){
          clearTimeout(timer);
          if (script.parentNode) script.parentNode.removeChild(script);
          try{ delete window[cbName]; }catch(_){ window[cbName] = undefined; }
        }

        window[cbName] = (data) => {
          cleanup();
          resolve(data);
        };

        script.onerror = () => {
          cleanup();
          reject(new Error('jsonp_error'));
        };

        script.src = u.toString();
        document.head.appendChild(script);
      });
    }

    async function api(base, token, data){
      const body = Object.assign({}, data, { token });
      let json;
      if (shouldUseJsonp(base)){
        json = await jsonpRequest(base, body);
      } else {
        let resp;
        try{
          resp = await fetch(base, {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify(body)
          });
        }catch(err){
          throw new Error(`fetch_failed (${data.mode || 'unknown'}): ${err.message || err}`);
        }
        let text = '';
        try{ text = await resp.text(); }catch(_){}
        try{ json = text ? JSON.parse(text) : {}; }catch(_){
          throw new Error(`bad_json (${data.mode || 'unknown'}): ${text.slice(0,200)}`);
        }
        if (!resp.ok){
          const errMsg = json && json.error ? json.error : (resp.status + ' ' + resp.statusText);
          throw new Error(`http_${resp.status} (${data.mode || 'unknown'}): ${errMsg}`);
        }
      }
      if (!json || !json.ok){
        const msg = json && json.error ? json.error : 'api_error';
        throw new Error(`${msg} (${data.mode || 'unknown'})`);
      }
      return json;
    }

    function renderSummary(s){
      if (!s || !s.ok) { els.summary.textContent = '—'; return; }
      els.summary.textContent = `Всего: ${s.total||0}, online: ${s.online||0}, обновлено: ${fmtTime(s.updated_ms)}`;
    }

    function renderTable(items){
      const now = Date.now();
      state.devices = items;
      const rows = items.sort((a,b)=> (b.last_seen||0)-(a.last_seen||0)).map(dev => {
        const last = dev.last_seen ? humanAgo(now - dev.last_seen) : '—';
        const status = (dev.status || 'unknown').toLowerCase();
        const pending = dev.command ? dev.command.cmd : '';
        const tags = Array.isArray(dev.tags) ? dev.tags.join(', ') : '';
        const info = dev.info ? truncate(JSON.stringify(dev.info), 60) : '';
        const cfg = dev.config_rev ? ('rev ' + dev.config_rev) : '';
        return `<tr>
          <td>${escape(dev.id)}</td>
          <td>${escape(dev.name||'')}</td>
          <td><span class="status"><span class="dot ${status === 'online' || status === 'ok' ? 'ok' : 'offline'}"></span>${escape(status)}</span></td>
          <td>${last}</td>
          <td>${escape(dev.fw||'')}</td>
          <td>${escape(dev.ip||'')}</td>
          <td>${escape(tags)}</td>
          <td>${escape(cfg)}</td>
          <td class="clip">${escape(info||'')}</td>
          <td>${escape(pending||'')}</td>
        </tr>`;
      }).join('');
      els.rows.innerHTML = rows || '<tr><td colspan="10" class="muted">Нет данных</td></tr>';
    }

    function humanAgo(ms){
      if (!ms || ms < 0) return '—';
      const sec = Math.round(ms/1000);
      if (sec < 60) return sec + 's';
      const m = Math.round(sec/60);
      if (m < 60) return m + 'm';
      const h = Math.round(m/60);
      if (h < 48) return h + 'h';
      const d = Math.round(h/24);
      return d + 'd';
    }

    function fmtTime(ts){
      if (!ts) return '—';
      const d = new Date(ts);
      return d.toISOString().replace('T',' ').replace('Z','');
    }

    function flash(text){ els.msg.textContent = text; }
    function formatErr(err){
      if (!err) return 'error';
      if (typeof err === 'string') return err;
      return err.message || String(err);
    }
    function escape(s){ return String(s||'').replace(/[&<>]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c])); }
    function truncate(s, n){ return s.length > n ? s.slice(0, n-1) + '…' : s; }

    function onRowClick(e){
      const tr = e.target.closest('tr');
      if (!tr) return;
      const idCell = tr.querySelector('td');
      if (!idCell) return;
      const id = idCell.textContent.trim();
      if (id) selectDevice(id);
    }

    function selectDevice(id){
      const dev = state.devices.find(d => d.id === id);
      if (!dev) return;
      els.cfgTarget.value = id;
      ls.set('fleet.cfgTarget', id);
      if (dev.config !== undefined){
        els.cfgJson.value = dev.config ? JSON.stringify(dev.config, null, 2) : '';
      }
      const info = {
        id: dev.id,
        name: dev.name,
        status: dev.status,
        fw: dev.fw,
        ip: dev.ip,
        tags: dev.tags,
        info: dev.info,
        metrics: dev.metrics,
        last_seen: dev.last_seen,
        config_rev: dev.config_rev,
        config_updated: dev.config_updated
      };
      els.cfgInfo.textContent = JSON.stringify(info, null, 2);
      updateNetCheck(dev.ip);
      updateFileManagerLink(dev.ip);
    }

    function updateFileManagerLink(ip){
      if (ip && typeof ip === 'string' && ip.includes('.')) {
        const url = `https://${ip}/list`;
        els.btnOpenFm.disabled = false;
        els.btnOpenFm.onclick = () => window.open(url, '_blank');
      } else {
        els.btnOpenFm.disabled = true;
        els.btnOpenFm.onclick = null;
      }
    }

    function updateNetCheck(ip){
      const host = window.location.hostname || '';
      const pageNet = ipv4NetPrefix(host);
      const devNet = ipv4NetPrefix(ip);
      if (!devNet) {
        els.netCheck.textContent = 'Network: device IP неизвестен';
        return;
      }
      if (!pageNet) {
        els.netCheck.textContent = 'Network: страница не в локальной сети';
        return;
      }
      els.netCheck.textContent = (pageNet === devNet)
        ? `Network: same subnet (${devNet}0/24)`
        : `Network: different subnets (${pageNet}0/24 vs ${devNet}0/24)`;
    }

    function ipv4NetPrefix(ip){
      if (!ip || typeof ip !== 'string') return '';
      const m = ip.match(/^(\d{1,3})\.(\d{1,3})\.(\d{1,3})\.\d{1,3}$/);
      if (!m) return '';
      const a = Number(m[1]), b = Number(m[2]), c = Number(m[3]);
      if ([a,b,c].some(v => v < 0 || v > 255)) return '';
      return `${a}.${b}.${c}.`;
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
